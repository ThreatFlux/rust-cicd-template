# ThreatFlux Release Workflow
# Automated release with multi-platform builds
# Version: 1.1.0

name: Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.0.0)"
        required: true
        type: string
      prerelease:
        description: "Is this a pre-release?"
        required: false
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ==========================================================================
  # Prepare Release
  # ==========================================================================
  prepare:
    name: Prepare Release
    runs-on: self-hosted
    outputs:
      version: ${{ steps.version.outputs.version }}
      upload_url: ${{ steps.release.outputs.upload_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "Invalid version format: $VERSION"
            exit 1
          fi

      - name: Generate release notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "## Release v$VERSION" > release_notes.md
          echo "" >> release_notes.md
          if [ -f CHANGELOG.md ]; then
            awk "/## \[$VERSION\]/,/## \[/" CHANGELOG.md | sed '1d;$d' >> release_notes.md 2>/dev/null || echo "See CHANGELOG.md for details" >> release_notes.md
          fi

      - name: Create GitHub Release
        id: release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease || contains(steps.version.outputs.version, '-') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================================================
  # Build Release Artifacts
  # ==========================================================================
  build:
    name: Build (${{ matrix.target }})
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: self-hosted
            target: x86_64-unknown-linux-gnu
            artifact: linux-amd64
          - os: self-hosted
            target: x86_64-unknown-linux-musl
            artifact: linux-musl-amd64
            use_cross: true
          - os: self-hosted
            target: aarch64-unknown-linux-gnu
            artifact: linux-arm64
            use_cross: true
          - os: macos-14
            target: aarch64-apple-darwin
            artifact: macos-arm64
          - os: macos-13
            target: x86_64-apple-darwin
            artifact: macos-amd64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: windows-amd64
    runs-on: ${{ matrix.os }}
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: Install dependencies (Ubuntu)
        if: contains(matrix.os, 'self-hosted') || contains(matrix.os, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config

      - name: Install cross
        if: matrix.use_cross
        run: cargo install cross

      - name: Build (cross)
        if: matrix.use_cross
        run: cross build --release --target ${{ matrix.target }} --all-features

      - name: Build (native)
        if: "!matrix.use_cross"
        run: cargo build --release --target ${{ matrix.target }} --all-features

      - name: Package (Unix)
        if: runner.os != 'Windows'
        run: |
          BINARY_NAME=$(cargo metadata --format-version 1 --no-deps | jq -r '.packages[0].name')
          mkdir -p dist
          cp target/${{ matrix.target }}/release/$BINARY_NAME dist/ 2>/dev/null || true
          cd dist
          tar czf ../$BINARY_NAME-${{ matrix.artifact }}.tar.gz *
          cd ..
          shasum -a 256 $BINARY_NAME-${{ matrix.artifact }}.tar.gz > $BINARY_NAME-${{ matrix.artifact }}.tar.gz.sha256

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $meta = cargo metadata --format-version 1 --no-deps | ConvertFrom-Json
          $name = $meta.packages[0].name
          mkdir dist
          Copy-Item "target/${{ matrix.target }}/release/$name.exe" dist/
          Compress-Archive -Path dist/* -DestinationPath "$name-${{ matrix.artifact }}.zip"
          Get-FileHash "$name-${{ matrix.artifact }}.zip" -Algorithm SHA256 | Format-List

      - name: Upload artifacts (Unix)
        if: runner.os != 'Windows'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: release-${{ matrix.artifact }}
          path: "*.tar.gz*"
          retention-days: 5

      - name: Upload artifacts (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: release-${{ matrix.artifact }}
          path: "*.zip"
          retention-days: 5

  # ==========================================================================
  # Upload Release Assets
  # ==========================================================================
  upload-assets:
    name: Upload Release Assets
    needs: [prepare, build]
    runs-on: self-hosted
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v4
        with:
          path: artifacts
          pattern: release-*

      - name: Upload to release
        run: |
          for file in artifacts/**/*; do
            if [ -f "$file" ]; then
              gh release upload "v${{ needs.prepare.outputs.version }}" "$file" --clobber || true
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================================================
  # Publish to crates.io
  # ==========================================================================
  publish:
    name: Publish to crates.io
    needs: [prepare, build]
    runs-on: self-hosted
    if: "!contains(needs.prepare.outputs.version, '-')"
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: stable

      - name: Check crates.io token
        id: check_token
        run: |
          if [ -n "${{ secrets.CARGO_REGISTRY_TOKEN }}" ]; then
            echo "has_token=true" >> $GITHUB_OUTPUT
          else
            echo "has_token=false" >> $GITHUB_OUTPUT
            echo "Skipping crates.io publish - token not configured"
          fi

      - name: Publish to crates.io
        if: steps.check_token.outputs.has_token == 'true'
        run: cargo publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        continue-on-error: true

  # ==========================================================================
  # Release Success Gate
  # ==========================================================================
  release-success:
    name: Release Success
    runs-on: self-hosted
    needs: [prepare, build, upload-assets]
    if: always()
    steps:
      - name: Check release status
        run: |
          if [[ "${{ needs.prepare.result }}" != "success" ]]; then
            echo "Release preparation failed"
            exit 1
          fi
          echo "Release completed successfully"
          echo "Version: ${{ needs.prepare.outputs.version }}"
