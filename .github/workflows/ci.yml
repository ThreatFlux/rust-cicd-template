# ThreatFlux CI Workflow
# Comprehensive Rust CI pipeline with best practices
# Version: 1.1.0

name: CI

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - "LICENSE"
      - ".gitignore"
      - "docs/**"
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - "LICENSE"
      - ".gitignore"
      - "docs/**"
  schedule:
    - cron: "0 0 * * 0" # Weekly on Sunday at midnight UTC
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  RUSTFLAGS: -D warnings
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  RUSTUP_MAX_RETRIES: 10

jobs:
  # ==========================================================================
  # Quick Checks - Fast feedback
  # ==========================================================================
  quick-check:
    name: Quick Check
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Cache cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: |
          cargo clippy --all-features --all-targets -- \
            -D warnings \
            -D clippy::all \
            -D clippy::pedantic \
            -D clippy::nursery \
            -A clippy::multiple_crate_versions \
            -A clippy::module_name_repetitions \
            -A clippy::missing_errors_doc \
            -A clippy::missing_panics_doc \
            -A clippy::must_use_candidate

  # ==========================================================================
  # Test Suite - Cross-platform testing
  # ==========================================================================
  test:
    name: Test (${{ matrix.os }} / ${{ matrix.rust }})
    needs: quick-check
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            runner: self-hosted
            rust: stable
          - os: linux
            runner: self-hosted
            rust: beta
          - os: linux
            runner: self-hosted
            rust: nightly
          - os: macos
            runner: macos-latest
            rust: stable
          - os: windows
            runner: windows-latest
            rust: stable
    continue-on-error: ${{ matrix.rust == 'nightly' }}

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: ${{ matrix.rust }}

      - name: Install dependencies (Ubuntu)
        if: matrix.os == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos'
        run: |
          brew install openssl@3
          echo "OPENSSL_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV

      - name: Cache cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-${{ matrix.rust }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.rust }}-cargo-

      - name: Build
        run: cargo build --all-features --verbose

      - name: Run tests
        run: cargo test --all-features --verbose

      - name: Run doc tests
        run: cargo test --doc --all-features

  # ==========================================================================
  # MSRV Check
  # ==========================================================================
  msrv:
    name: MSRV Check
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install MSRV toolchain
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: "1.92.0"

      - name: Cache cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
          key: ${{ runner.os }}-msrv-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Check MSRV
        run: cargo check --all-features

  # ==========================================================================
  # Feature Checks
  # ==========================================================================
  features:
    name: Feature Checks
    runs-on: self-hosted
    needs: quick-check
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: stable

      - name: Install cargo-hack
        uses: taiki-e/install-action@3522286d40783523f9c7880e33f785905b4c20d0 # main
        with:
          tool: cargo-hack

      - name: Cache cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-features-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Check no default features
        run: cargo check --no-default-features

      - name: Check all features
        run: cargo check --all-features

      - name: Check feature combinations
        run: cargo hack check --feature-powerset --no-dev-deps --exclude-no-default-features

  # ==========================================================================
  # Documentation
  # ==========================================================================
  docs:
    name: Documentation
    runs-on: self-hosted
    needs: quick-check
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: stable

      - name: Build documentation
        run: cargo doc --all-features --no-deps
        env:
          RUSTDOCFLAGS: -D warnings

      - name: Test documentation examples
        run: cargo test --doc --all-features

  # ==========================================================================
  # Benchmarks
  # ==========================================================================
  bench:
    name: Benchmarks
    runs-on: self-hosted
    needs: quick-check
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: stable

      - name: Cache cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-bench-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Check benchmarks compile
        run: cargo bench --all-features --no-run

  # ==========================================================================
  # Code Coverage
  # ==========================================================================
  coverage:
    name: Code Coverage
    runs-on: self-hosted
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: stable
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@3522286d40783523f9c7880e33f785905b4c20d0 # main
        with:
          tool: cargo-llvm-cov

      - name: Cache cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-coverage-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Generate coverage
        run: cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5
        with:
          files: lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  # ==========================================================================
  # CI Success Gate
  # ==========================================================================
  ci-success:
    name: CI Success
    runs-on: self-hosted
    needs: [quick-check, test, msrv, features, docs, bench]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.quick-check.result }}" != "success" || \
                "${{ needs.test.result }}" != "success" || \
                "${{ needs.msrv.result }}" != "success" || \
                "${{ needs.features.result }}" != "success" || \
                "${{ needs.docs.result }}" != "success" || \
                "${{ needs.bench.result }}" != "success" ]]; then
            echo "One or more required jobs failed"
            exit 1
          fi
          echo "All required jobs succeeded"
